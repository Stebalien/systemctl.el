#+TITLE: systemctl.el

An Emacs package for controlling [[https://systemd.io/][systemd]] over [[https://www.freedesktop.org/wiki/Software/dbus/][D-Bus]].

* Customization Options
:PROPERTIES:
:ID:       7bef501e-f8c4-47e1-82e8-9594629cbb08
:END:

*systemctl-manager*: By default, interactive commands that operate on services prompt for BOTH user and system services. If you only wish to operate on one of these, customize the ~systemctl-manager~ option. For example, if you don't use systemd's user manager, you'll likely want to add the following to your =init.el=:

#+begin_src elisp
(setopt systemctl-manager 'system)
#+end_src

*systemctl-unit-types*: By default, interactive commands only operate on =service= and =timer= units. To include other unit types, customize ~systemctl-unit-types~. For example, if you want to start/stop targets, you may want to add the following to your =init.el=:

#+begin_src elisp
(add-to-list 'systemctl-unit-types 'target)
#+end_src

* Power Menu
:PROPERTIES:
:ID:       b48585ab-aac7-4b69-9a44-e61f41d07267
:END:

This package includes a [[https://github.com/magit/transient][transient]]-based power menu (~systemctl-power-menu~):

#+caption: power-menu
[[file:screenshots/power-menu.png]]

In addition to the usual commands (sleep, reboot, shutdown, etc.):

- You can reboot into the firmware setup or even a specific operating system/kernel if your boot manager supports it. All unsupported features will be grayed out as in the above screenshot.
- If you increase the transient verbosity level (bound to =C-x a= in all transients by default), you can enter specific suspend states beyond the default "sleep" and "hibernate" options.

If transient menus aren't your style, all power commands can also be invoked as regular commands via =M-x= or bound to via keybindings (although none are defined by default). These commands are:

- ~systemctl-suspend~
- ~systemctl-hibernate~
- ~systemctl-hybrid-sleep~
- ~systemctl-suspend-then-hibernate~
- ~systemctl-sleep~
- ~systemctl-poweroff~
- ~systemctl-reboot~
- ~systemctl-halt~ (you probably want ~systemctl-poweroff~, not ~systemctl-halt~)

They correspond to the same commands as defined on the [[man:systemctl(1)][systemctl(1)]] shell command.

* Session Locking
:PROPERTIES:
:ID:       0cf357d6-9af2-47ba-bf17-628a7abb5fe2
:END:

This package implements two commands from the [[man:loginctl(1)][loginctl(1)]] shell command for locking/unlocking sessions. They don't precisely belong in a ~systemctl~ package but they're useful enough to include.

- ~systemd-lock~ locks the current session, the target session when called with a session ID (may require polkit authentication), or all sessions when called with the symbol ~t~ (requires polkit authentication).
- ~systemctl-unlock~ is the inverse of ~systemctl-lock~.

I haven't implemented any of the other [[man:loginctl(1)][loginctl(1)]] commands at the moment but I'm open to suggestions.

* Service Management
:PROPERTIES:
:ID:       b2fff18d-3cc7-4afa-a912-423e56fcdc35
:END:

Finally, as expected of a ~systemctl~ package, you can manage systemd services:

- ~systemctl-start~ starts a unit (service, timer, etc.), prompting for one if called interactively.
- ~systemctl-stop~ stops a service.
- ~systemctl-restart~ starts or restarts a service. Only restarts already running services when called with a prefix arg.
- ~systemctl-reload-or-restart~ reloads the config of a running service, or restarts it. If the service isn't running, it's started unless called with a prefix argument.
- ~systemctl-reload~ tells a running service to reload its config. You likely want to use ~systemctl-reload-or-restart~ instead as that will handle restarted services that can't be reloaded.
- ~systemctl-enable~ enables a unit to start automatically at boot.
- ~systemctl-disable~ disables a unit from starting automatically at boot.
- ~systemctl-mask~ masks a unit, completely preventing it from being started.
- ~systemctl-unmask~ unmasks a unit, allowing it to be started again.

The enable, disable, mask, and unmask commands support a prefix argument to operate only for the current session (runtime-only changes).

* Reloading Units & Systemd
:PROPERTIES:
:ID:       f25f4dbc-6e70-4aa9-938a-14da7f1f9140
:END:

You can reload the systemd daemon's config, unit files, etc. by calling ~systemctl-daemon-reload~.

* Unit Browser (~systemctl-ui~)
:PROPERTIES:
:ID:       8c2a4f1e-9b3d-4c5e-a7f2-1d6e8f0a2b4c
:END:

This package includes an automatically updated tabulated list interface for browsing and managing systemd units interactively. The command ~systemctl-ui-list-units~ opens a buffer displaying all available units with their current status.
